}<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jisoo Services PBX Connection Monitor</title>
    <!-- Add EmailJS SDK -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/emailjs-com/3.2.0/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            // EmailJS initialization instructions will appear here when you create an account
            // You'll need to replace these values with your own EmailJS user ID and template IDs
            // emailjs.init("YOUR_USER_ID");
        })();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .results {
            margin-top: 20px;
        }
        .pbx-result {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .pbx-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .pbx-title {
            font-weight: bold;
            font-size: 18px;
        }
        .status {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 14px;
        }
        .status-running {
            background-color: #f39c12;
            color: white;
        }
        .status-complete {
            background-color: #2ecc71;
            color: white;
        }
        .status-error {
            background-color: #e74c3c;
            color: white;
        }
        .log-container {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .options-panel {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 4px;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 0;
        }
        .checkbox-group input {
            margin-right: 5px;
        }
        .ping-summary {
            margin-top: 10px;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 4px;
        }
        .ping-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .ping-stat {
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .ping-stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }
        .ping-stat-value {
            font-size: 20px;
            font-weight: bold;
        }
        .good-value {
            color: #2ecc71;
        }
        .warning-value {
            color: #f39c12;
        }
        .error-value {
            color: #e74c3c;
        }
        .tools-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .tool-tab {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .tool-tab.active {
            border: 1px solid #ddd;
            border-bottom: 1px solid white;
            border-radius: 4px 4px 0 0;
            background-color: white;
            margin-bottom: -1px;
        }
        .stop-button {
            background-color: #e74c3c;
        }
        .stop-button:hover {
            background-color: #c0392b;
        }
        .copy-logs-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .copy-logs-btn:hover {
            background-color: #e0e0e0;
        }
        .copy-logs-btn svg {
            width: 14px;
            height: 14px;
        }
    </style>
</head>
<body>
    <h1>Jisoo Services PBX Connection Monitor</h1>
    <div class="container">
        <div class="form-group">
            <label for="ipAddresses">PBX IP Addresses or Domain Names (one per line):</label>
            <textarea id="ipAddresses" placeholder="Enter your PBX IP addresses or domain names here, one per line.
You can add a description after a comma.

Examples:
192.168.1.100, Main Office PBX
pbx.example.com, Branch Office
10.15.41.238, Remote Location"></textarea>
        </div>
        
        <div class="options-panel">
            <label>Test Options:</label>
            <div class="tools-tabs">
                <div class="tool-tab active" data-tool="ping">Ping Test</div>
                <div class="tool-tab" data-tool="traceroute">Traceroute</div>
                <div class="tool-tab" data-tool="portscan">Port Scan</div>
            </div>
            
            <div id="pingOptions" class="tool-options">
                <div class="form-group">
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="continuousPing" checked> Continuous monitoring</label>
                        <label><input type="checkbox" id="showPacketLoss" checked> Highlight packet loss</label>
                        <label><input type="checkbox" id="showLatencyIssues" checked> Highlight latency issues</label>
                    </div>
                    <div style="margin-top: 10px;">
                        <label><input type="number" id="pingCount" value="10" min="1" max="100" style="width: 50px;"> Number of pings (when not continuous)</label>
                    </div>
                                            <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 10px;">Email Alerts</label>
                        <label style="display: flex; align-items: center;"><input type="checkbox" id="emailAlerts"> Enable email notifications for issues</label>
                    
                        <div id="emailSettings" style="margin-top: 10px; display: none; background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <div>
                                    <label for="alertEmail" style="display: block; margin-bottom: 5px;">Alert Email Address:</label>
                                    <input type="email" id="alertEmail" placeholder="alerts@example.com" style="width: 220px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                </div>
                                <div>
                                    <label for="alertThreshold" style="display: block; margin-bottom: 5px;">Packet Loss Threshold:</label>
                                    <select id="alertThreshold" style="width: 150px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                        <option value="1">Any packet loss</option>
                                        <option value="5" selected>5% packet loss</option>
                                        <option value="10">10% packet loss</option>
                                        <option value="20">20% packet loss</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="alertLatency" style="display: block; margin-bottom: 5px;">Latency Threshold (ms):</label>
                                    <input type="number" id="alertLatency" value="150" min="10" max="1000" style="width: 100px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                </div>
                            </div>
                            <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;">
                                <div style="display: flex; gap: 15px;">
                                    <div>
                                        <label>
                                            <input type="radio" name="emailMethod" value="mailto" checked> 
                                            Use default email client
                                        </label>
                                    </div>
                                    <div>
                                        <label>
                                            <input type="radio" name="emailMethod" value="emailjs"> 
                                            Use EmailJS (requires setup)
                                        </label>
                                    </div>
                                </div>
                                <div id="emailjsSettings" style="margin-top: 10px; display: none;">
                                    <div style="margin-bottom: 10px;">
                                        <label for="emailjs_user_id" style="display: block; margin-bottom: 5px;">EmailJS User ID:</label>
                                        <input type="text" id="emailjs_user_id" placeholder="user_xxxxxxxxxxxxxxxxxxxxxxxx" style="width: 300px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label for="emailjs_service_id" style="display: block; margin-bottom: 5px;">Service ID:</label>
                                        <input type="text" id="emailjs_service_id" placeholder="default_service" style="width: 300px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                    </div>
                                    <div>
                                        <label for="emailjs_template_id" style="display: block; margin-bottom: 5px;">Template ID:</label>
                                        <input type="text" id="emailjs_template_id" placeholder="template_xxxxxxxxxx" style="width: 300px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <p>To use EmailJS, you need to <a href="https://www.emailjs.com/" target="_blank">create an account</a>, set up a service and template, then enter the IDs above.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="tracerouteOptions" class="tool-options hidden">
                <div class="form-group">
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="showTracerouteHops" checked> Show all hops</label>
                        <label><input type="checkbox" id="highlightLongHops" checked> Highlight long hops</label>
                    </div>
                </div>
            </div>
            
            <div id="portscanOptions" class="tool-options hidden">
                <div class="form-group">
                    <div class="checkbox-group">
                        <label>Common PBX ports:</label>
                        <label><input type="checkbox" id="port5060" checked> SIP (5060)</label>
                        <label><input type="checkbox" id="port5061" checked> SIP TLS (5061)</label>
                        <label><input type="checkbox" id="port10000" checked> RTP (10000-20000)</label>
                        <label><input type="checkbox" id="port443" checked> HTTPS (443)</label>
                        <label><input type="checkbox" id="port80" checked> HTTP (80)</label>
                        <label><input type="checkbox" id="port8088" checked> Yeastar (8088)</label>
                        <label><input type="checkbox" id="port8089" checked> Yeastar API (8089)</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <button id="startButton">Start Monitoring</button>
            <button id="stopButton" class="stop-button" disabled>Stop All Tests</button>
        </div>
        
        <div id="results" class="results"></div>
    </div>

    <script>
        // Main controller for the application
        class PBXMonitor {
            constructor() {
                this.activeTests = {};
                this.selectedTool = 'ping';
                this.initEventListeners();
            }
            
            initEventListeners() {
                // Button listeners
                document.getElementById('startButton').addEventListener('click', () => this.startTests());
                document.getElementById('stopButton').addEventListener('click', () => this.stopAllTests());
                
                // Tab switching
                document.querySelectorAll('.tool-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTool(e.target.dataset.tool));
                });
                
                // Copy logs button event delegation
                document.getElementById('results').addEventListener('click', (e) => {
                    if (e.target.closest('.copy-logs-btn')) {
                        const btn = e.target.closest('.copy-logs-btn');
                        const ip = btn.dataset.ip;
                        this.copyLogs(ip);
                    }
                });
            }
            
            // Copy logs to clipboard
            copyLogs(ip) {
                const logContainer = this.getLogContainer(ip);
                const logText = logContainer.innerText;
                
                // Create a temporary textarea element to copy from
                const textarea = document.createElement('textarea');
                textarea.value = logText;
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    // Execute copy command
                    document.execCommand('copy');
                    
                    // Show success message
                    const btn = document.querySelector(`.copy-logs-btn[data-ip="${ip}"]`);
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Copied!
                    `;
                    btn.style.backgroundColor = '#2ecc71';
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.backgroundColor = '';
                    }, 2000);
                    
                } catch (err) {
                    console.error('Failed to copy logs:', err);
                    alert('Failed to copy logs. Please try again.');
                }
                
                // Remove the temporary textarea
                document.body.removeChild(textarea);
            }
            
            switchTool(tool) {
                // Update active tab
                document.querySelectorAll('.tool-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tool === tool);
                });
                
                // Show corresponding options
                document.querySelectorAll('.tool-options').forEach(options => {
                    options.classList.add('hidden');
                });
                document.getElementById(`${tool}Options`).classList.remove('hidden');
                
                this.selectedTool = tool;
            }
            
            getIPAddresses() {
                const text = document.getElementById('ipAddresses').value.trim();
                if (!text) return [];
                
                return text.split('\n')
                    .map(line => {
                        const parts = line.split(',').map(part => part.trim());
                        const ip = parts[0];
                        const name = parts.length > 1 ? parts[1] : '';
                        
                        if (ip && this.isValidIP(ip)) {
                            return { ip, name };
                        }
                        return null;
                    })
                    .filter(item => item !== null);
            }
            
            isValidIP(ip) {
                // Basic IP validation regex
                const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
                
                // FQDN validation regex
                const fqdnRegex = /^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/;
                
                return ipRegex.test(ip) || fqdnRegex.test(ip);
            }
            
            startTests() {
                const ipEntries = this.getIPAddresses();
                
                if (ipEntries.length === 0) {
                    alert('Please enter at least one valid IP address or domain name.');
                    return;
                }
                
                // Clear previous results if needed
                if (Object.keys(this.activeTests).length === 0) {
                    document.getElementById('results').innerHTML = '';
                }
                
                // Enable stop button
                document.getElementById('stopButton').disabled = false;
                document.getElementById('startButton').disabled = true;
                
                // Start tests for each IP
                ipEntries.forEach(entry => {
                    const ip = entry.ip;
                    const name = entry.name;
                    
                    if (!this.activeTests[ip]) {
                        this.createResultPanel(ip, name);
                        
                        switch (this.selectedTool) {
                            case 'ping':
                                this.startPingTest(ip);
                                break;
                            case 'traceroute':
                                this.startTraceroute(ip);
                                break;
                            case 'portscan':
                                this.startPortScan(ip);
                                break;
                        }
                    }
                });
            }
            
            createResultPanel(ip, name = '') {
                const resultsContainer = document.getElementById('results');
                
                const panel = document.createElement('div');
                panel.className = 'pbx-result';
                panel.id = `result-${ip.replace(/\./g, '-').replace(/[^a-zA-Z0-9-]/g, '-')}`;
                
                const displayName = name ? `${ip} (${name})` : ip;
                
                panel.innerHTML = `
                    <div class="pbx-header">
                        <div class="pbx-title">${displayName}</div>
                        <div class="status status-running">Running</div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 5px;">
                        <button class="copy-logs-btn" data-ip="${ip}" title="Copy all logs to clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copy Logs
                        </button>
                    </div>
                    <div class="log-container"></div>
                `;
                
                resultsContainer.appendChild(panel);
                return panel;
            }
            
            getLogContainer(ip) {
                const resultPanel = document.getElementById(`result-${ip.replace(/\./g, '-').replace(/[^a-zA-Z0-9-]/g, '-')}`);
                return resultPanel.querySelector('.log-container');
            }
            
            updateResultStatus(ip, status) {
                const resultPanel = document.getElementById(`result-${ip.replace(/\./g, '-').replace(/[^a-zA-Z0-9-]/g, '-')}`);
                const statusElement = resultPanel.querySelector('.status');
                
                statusElement.className = `status status-${status}`;
                statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            }
            
            appendToLog(ip, message, type = 'info') {
                const logContainer = this.getLogContainer(ip);
                const line = document.createElement('div');
                line.className = `log-line log-${type}`;
                line.textContent = message;
                logContainer.appendChild(line);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            // Simulated ping test (for demo purposes)
            startPingTest(ip) {
                const logContainer = this.getLogContainer(ip);
                const continuous = document.getElementById('continuousPing').checked;
                const pingCount = continuous ? 999999 : parseInt(document.getElementById('pingCount').value);
                const showPacketLoss = document.getElementById('showPacketLoss').checked;
                const showLatencyIssues = document.getElementById('showLatencyIssues').checked;
                
                this.activeTests[ip] = {
                    type: 'ping',
                    count: 0,
                    active: true,
                    hasTimeout: false,
                    lastAlertSent: null,
                    name: name || '',
                    stats: {
                        sent: 0,
                        received: 0,
                        min: Infinity,
                        max: 0,
                        avg: 0,
                        totalTime: 0
                    }
                };
                
                this.appendToLog(ip, `Starting ping test to ${ip}...`);
                
                // Add ping summary section
                const summarySection = document.createElement('div');
                summarySection.className = 'ping-summary';
                summarySection.innerHTML = `
                    <div><strong>Ping Statistics</strong></div>
                    <div class="ping-stats">
                        <div class="ping-stat">
                            <div class="ping-stat-label">Packet Loss</div>
                            <div class="ping-stat-value" id="loss-${ip.replace(/\./g, '-')}">0%</div>
                        </div>
                        <div class="ping-stat">
                            <div class="ping-stat-label">Avg Latency</div>
                            <div class="ping-stat-value" id="avg-${ip.replace(/\./g, '-')}">0ms</div>
                        </div>
                        <div class="ping-stat">
                            <div class="ping-stat-label">Min Latency</div>
                            <div class="ping-stat-value" id="min-${ip.replace(/\./g, '-')}">0ms</div>
                        </div>
                        <div class="ping-stat">
                            <div class="ping-stat-label">Max Latency</div>
                            <div class="ping-stat-value" id="max-${ip.replace(/\./g, '-')}">0ms</div>
                        </div>
                    </div>
                `;
                logContainer.parentNode.insertBefore(summarySection, logContainer);
                
                const pingInterval = setInterval(() => {
                    if (!this.activeTests[ip] || !this.activeTests[ip].active) {
                        clearInterval(pingInterval);
                        return;
                    }
                    
                    this.activeTests[ip].count++;
                    if (this.activeTests[ip].count > pingCount) {
                        this.stopTest(ip);
                        return;
                    }
                    
                    // Simulate ping response with some randomness
                    this.activeTests[ip].stats.sent++;
                    
                    // Simulate some packet loss (5% chance)
                    if (Math.random() > 0.95) {
                        this.appendToLog(ip, `Request timeout for icmp_seq=${this.activeTests[ip].count}`, 'error');
                        this.activeTests[ip].hasTimeout = true;
                    } else {
                        // Random latency between 10-300ms with occasional spikes
                        let latency = Math.random() < 0.1 ? 
                            Math.floor(Math.random() * 200) + 100 : // Occasional high latency
                            Math.floor(Math.random() * 50) + 10;    // Normal latency
                        
                        this.activeTests[ip].stats.received++;
                        this.activeTests[ip].stats.totalTime += latency;
                        this.activeTests[ip].stats.min = Math.min(this.activeTests[ip].stats.min, latency);
                        this.activeTests[ip].stats.max = Math.max(this.activeTests[ip].stats.max, latency);
                        this.activeTests[ip].stats.avg = Math.floor(this.activeTests[ip].stats.totalTime / this.activeTests[ip].stats.received);
                        
                        // Format message based on latency
                        let messageType = 'info';
                        if (showLatencyIssues && latency > 100) {
                            messageType = 'error';
                        } else if (showLatencyIssues && latency > 50) {
                            messageType = 'warning';
                        }
                        
                        this.appendToLog(
                            ip, 
                            `64 bytes from ${ip}: icmp_seq=${this.activeTests[ip].count} ttl=59 time=${latency} ms`, 
                            messageType
                        );
                    }
                    
                    // Update summary stats
                    this.updatePingStats(ip);
                    
                }, 1000);
            }
            
            updatePingStats(ip) {
                const stats = this.activeTests[ip].stats;
                const packetLoss = stats.sent > 0 ? (1 - stats.received / stats.sent) * 100 : 0;
                
                // Update the summary display
                const cleanIp = ip.replace(/\./g, '-').replace(/[^a-zA-Z0-9-]/g, '-');
                document.getElementById(`loss-${cleanIp}`).textContent = `${packetLoss.toFixed(1)}%`;
                document.getElementById(`avg-${cleanIp}`).textContent = `${stats.avg}ms`;
                document.getElementById(`min-${cleanIp}`).textContent = `${stats.min === Infinity ? 0 : stats.min}ms`;
                document.getElementById(`max-${cleanIp}`).textContent = `${stats.max}ms`;
                
                // Add color coding
                this.colorPingStat(`loss-${cleanIp}`, packetLoss, [0, 5, 20]);
                this.colorPingStat(`avg-${cleanIp}`, stats.avg, [30, 80, 150]);
                this.colorPingStat(`max-${cleanIp}`, stats.max, [50, 100, 200]);
                
                // Check if email alerts are enabled and we should send an alert
                if (document.getElementById('emailAlerts').checked) {
                    const alertEmail = document.getElementById('alertEmail').value;
                    const alertThreshold = parseFloat(document.getElementById('alertThreshold').value);
                    const alertLatency = parseFloat(document.getElementById('alertLatency').value);
                    
                    if (alertEmail && 
                        ((packetLoss >= alertThreshold) || 
                         (stats.max >= alertLatency) || 
                         (this.activeTests[ip].hasTimeout))) {
                        
                        this.sendAlert(ip, {
                            packetLoss,
                            avgLatency: stats.avg,
                            maxLatency: stats.max,
                            hasTimeout: this.activeTests[ip].hasTimeout
                        });
                    }
                }
            }
            
            sendAlert(ip, stats) {
                // Prevent sending multiple alerts for the same issue
                const now = new Date().getTime();
                if (this.activeTests[ip].lastAlertSent && 
                    (now - this.activeTests[ip].lastAlertSent < 300000)) { // 5 minutes cooldown
                    return;
                }
                
                this.activeTests[ip].lastAlertSent = now;
                
                // Get alert email and create alert message
                const alertEmail = document.getElementById('alertEmail').value;
                
                // Create alert reason
                let alertReason = [];
                if (stats.hasTimeout) alertReason.push("Connection timeouts detected");
                if (stats.packetLoss >= parseFloat(document.getElementById('alertThreshold').value)) 
                    alertReason.push(`High packet loss (${stats.packetLoss.toFixed(1)}%)`);
                if (stats.maxLatency >= parseFloat(document.getElementById('alertLatency').value))
                    alertReason.push(`High latency (${stats.maxLatency}ms)`);
                
                const subject = `PBX Alert: Issues with ${ip}${this.activeTests[ip].name ? ' (' + this.activeTests[ip].name + ')' : ''}`;
                const body = `
Time: ${new Date().toLocaleString()}
Issues: ${alertReason.join(", ")}

Current Statistics:
- Packet Loss: ${stats.packetLoss.toFixed(1)}%
- Average Latency: ${stats.avgLatency}ms
- Maximum Latency: ${stats.maxLatency}ms

This alert was sent from the PBX Connection Monitor.
                `;
                
                // Method 1: Using mailto link to open default email client
                const mailtoLink = `mailto:${encodeURIComponent(alertEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Check which email method is selected
                const emailMethod = document.querySelector('input[name="emailMethod"]:checked').value;
                
                if (emailMethod === 'emailjs') {
                    // Method 2: Using Email JS (requires account setup and configuration)
                    const userId = document.getElementById('emailjs_user_id').value;
                    const serviceId = document.getElementById('emailjs_service_id').value;
                    const templateId = document.getElementById('emailjs_template_id').value;
                    
                    if (userId && serviceId && templateId) {
                        try {
                            // Initialize EmailJS with the user's ID
                            emailjs.init(userId);
                            
                            // Send the email
                            emailjs.send(serviceId, templateId, {
                                to_email: alertEmail,
                                subject: subject,
                                message: body,
                                ip_address: ip
                            }).then(
                                function(response) {
                                    console.log("Email sent successfully:", response);
                                },
                                function(error) {
                                    console.error("Email failed to send:", error);
                                    // Fallback to mailto
                                    window.open(mailtoLink);
                                }
                            );
                        } catch (e) {
                            console.error("Error with EmailJS:", e);
                            // Fallback to mailto
                            window.open(mailtoLink);
                        }
                    } else {
                        // EmailJS selected but not configured properly
                        this.appendToLog(ip, `⚠️ EmailJS not configured. Please fill in all required fields.`, 'error');
                        // Fallback to mailto
                        window.open(mailtoLink);
                    }
                } else {
                    // Default method: Use mailto link to open default email client
                    window.open(mailtoLink);
                }
                
                // Show alert sent notification to user
                this.appendToLog(ip, `📧 Alert email sent to ${alertEmail} - ${alertReason.join(", ")}`, 'warning');
            }
            
            colorPingStat(elementId, value, thresholds) {
                const element = document.getElementById(elementId);
                element.classList.remove('good-value', 'warning-value', 'error-value');
                
                if (value <= thresholds[0]) {
                    element.classList.add('good-value');
                } else if (value <= thresholds[1]) {
                    element.classList.add('good-value');
                } else if (value <= thresholds[2]) {
                    element.classList.add('warning-value');
                } else {
                    element.classList.add('error-value');
                }
            }
            
            // Simulated traceroute (for demo purposes)
            startTraceroute(ip) {
                const name = this.activeTests[ip]?.name || '';
                
                this.activeTests[ip] = {
                    type: 'traceroute',
                    active: true,
                    name: name
                };
                
                this.appendToLog(ip, `Starting traceroute to ${ip}...`);
                
                // Simulate traceroute with randomized hops
                const numHops = Math.floor(Math.random() * 8) + 5; // 5-12 hops
                const showAllHops = document.getElementById('showTracerouteHops').checked;
                const highlightLongHops = document.getElementById('highlightLongHops').checked;
                
                let currentHop = 0;
                const hops = [];
                
                // Generate simulated route
                for (let i = 1; i <= numHops; i++) {
                    const hop = {
                        num: i,
                        ip: i === numHops ? ip : `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`,
                        latency: Math.floor(Math.random() * 30) + 5,
                        name: i === numHops ? 'pbx.yeastar-p570.local' : `router-${i}.local`
                    };
                    
                    // Simulate a slow hop occasionally
                    if (i > 1 && i < numHops && Math.random() < 0.2) {
                        hop.latency += Math.floor(Math.random() * 100) + 50;
                    }
                    
                    hops.push(hop);
                }
                
                const tracerouteInterval = setInterval(() => {
                    if (!this.activeTests[ip] || !this.activeTests[ip].active) {
                        clearInterval(tracerouteInterval);
                        return;
                    }
                    
                    if (currentHop >= hops.length) {
                        this.appendToLog(ip, `Traceroute to ${ip} completed.`);
                        this.stopTest(ip);
                        return;
                    }
                    
                    const hop = hops[currentHop];
                    let messageType = 'info';
                    if (highlightLongHops && hop.latency > 100) {
                        messageType = 'error';
                    } else if (highlightLongHops && hop.latency > 50) {
                        messageType = 'warning';
                    }
                    
                    this.appendToLog(
                        ip, 
                        `${hop.num}  ${hop.ip} (${hop.name})  ${hop.latency} ms`, 
                        messageType
                    );
                    
                    currentHop++;
                }, 500);
            }
            
            // Simulated port scan (for demo purposes)
            startPortScan(ip) {
                const name = this.activeTests[ip]?.name || '';
                
                this.activeTests[ip] = {
                    type: 'portscan',
                    active: true,
                    name: name
                };
                
                this.appendToLog(ip, `Starting port scan on ${ip}...`);
                
                // Get selected ports
                const ports = [];
                if (document.getElementById('port5060').checked) ports.push(5060);
                if (document.getElementById('port5061').checked) ports.push(5061);
                if (document.getElementById('port443').checked) ports.push(443);
                if (document.getElementById('port80').checked) ports.push(80);
                if (document.getElementById('port8088').checked) ports.push(8088);
                if (document.getElementById('port8089').checked) ports.push(8089);
                
                // Add RTP range sample ports
                if (document.getElementById('port10000').checked) {
                    ports.push(10000, 10100, 10200, 15000, 19999);
                }
                
                let currentPort = 0;
                const scanInterval = setInterval(() => {
                    if (!this.activeTests[ip] || !this.activeTests[ip].active) {
                        clearInterval(scanInterval);
                        return;
                    }
                    
                    if (currentPort >= ports.length) {
                        this.appendToLog(ip, `Port scan on ${ip} completed.`);
                        this.stopTest(ip);
                        return;
                    }
                    
                    const port = ports[currentPort];
                    const isOpen = Math.random() > 0.3; // Simulate 70% chance port is open
                    
                    let portName = "";
                    switch(port) {
                        case 5060: portName = "SIP"; break;
                        case 5061: portName = "SIP TLS"; break;
                        case 443: portName = "HTTPS"; break;
                        case 80: portName = "HTTP"; break;
                        case 8088: portName = "Yeastar Web"; break;
                        case 8089: portName = "Yeastar API"; break;
                        default: 
                            if (port >= 10000 && port < 20000) {
                                portName = "RTP";
                            }
                    }
                    
                    const status = isOpen ? "open" : "closed";
                    const messageType = isOpen ? 'info' : 'error';
                    
                    this.appendToLog(
                        ip, 
                        `Port ${port} (${portName}): ${status}`, 
                        messageType
                    );
                    
                    currentPort++;
                }, 500);
            }
            
            stopTest(ip) {
                if (this.activeTests[ip]) {
                    this.activeTests[ip].active = false;
                    this.updateResultStatus(ip, 'complete');
                    delete this.activeTests[ip];
                    
                    // Enable start button if all tests are stopped
                    if (Object.keys(this.activeTests).length === 0) {
                        document.getElementById('startButton').disabled = false;
                        document.getElementById('stopButton').disabled = true;
                    }
                }
            }
            
            stopAllTests() {
                Object.keys(this.activeTests).forEach(ip => {
                    this.stopTest(ip);
                });
                
                document.getElementById('startButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            window.pbxMonitor = new PBXMonitor();
            
            // Toggle email settings visibility
            document.getElementById('emailAlerts').addEventListener('change', function() {
                document.getElementById('emailSettings').style.display = this.checked ? 'block' : 'none';
            });
            
            // Toggle EmailJS settings visibility
            document.querySelectorAll('input[name="emailMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('emailjsSettings').style.display = 
                        document.querySelector('input[name="emailMethod"]:checked').value === 'emailjs' ? 'block' : 'none';
                });
            });
        });
    </script>
</body>
</html>
